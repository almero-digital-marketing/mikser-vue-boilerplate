"use strict";const{machineIdSync:e}=require("node-machine-id"),t=require("aguid"),o=require("os"),{v1:a}=require("uuid"),n=require("axios"),c=require("bluebird"),{flockAsync:l}=c.promisifyAll(require("fs-ext")),r=require("queue"),i=require("form-data"),s=require("hasha"),d=require("path"),u=require("glob-promise"),f=require("fs-extra-promise"),{throttle:h}=require("throttle-debounce");module.exports=async({filter:p,action:y,init:E},O)=>{const m=Date.now(),_=e()+"_"+o.hostname()+"_"+o.userInfo().username;let v=r({concurrency:3,autostart:!0});const w=d.resolve(O.env.STORAGE_LOCAL_ROOT),I=new Set,{ItemsService:T}=O.services,g=await O.getSchema();let{collections:B}=g;const A=Object.keys(B).filter((e=>0!=e.indexOf("directus_"))).map((e=>B[e])).filter((e=>e.fields.target&&"whitebox"==e.fields.target.defaultValue));if(c.resolve(),O.env.WHITEBOX_CLEAR||O.env.WHITEBOX_REFRESH){console.log("Clear whtiebox data");let e={};O.env.WHITEBOX_GLOBAL||(e.context=_),H("feed","/api/catalog/clear",e).then((()=>{if(O.clear)return n.post(O.env.WHITEBOX_STORAGE_URL+"/"+O.env.WHITEBOX_STORAGE_TOKEN+"/clear",{})})).catch((e=>console.error("Error clearing:",e)))}let L={};function H(e,t,o){return n.post(O.env["WHITEBOX_"+e.toUpperCase()+"_URL"]+t+"?v="+Date.now(),o,{headers:{Authorization:"Bearer "+O.env["WHITEBOX_"+e.toUpperCase()+"_TOKEN"]}}).then((e=>e.data.success?c.resolve(e.data):(console.error("Api service error:",t,o,e.data.message),c.reject(e.data.message)))).catch((e=>(console.error("Api system error:",t,o,e),c.resolve())))}function X(e){return L[e]?c.resolve():(L[e]=!0,f.openAsync(e,"r").then((t=>l(t,"sh").then((()=>{let o=e.replace(w,""),a={file:o};return O.env.WHITEBOX_GLOBAL||(a.context=_),n.post(O.env.WHITEBOX_STORAGE_URL+"/"+O.env.WHITEBOX_STORAGE_TOKEN+"/hash",a).then((t=>s.fromFile(e,{algorithm:"md5"}).then((a=>{if(!t.data.success||a!=t.data.hash){let t={};O.env.WHITEBOX_GLOBAL||(t={expire:O.env.WHITEBOX_EXPIRE||"10 days",context:_});let a=new i;a.append(o,f.createReadStream(e));let c=a.getHeaders();return n.post(O.env.WHITEBOX_STORAGE_URL+"/upload",a,{headers:{Authorization:"Bearer "+O.env.WHITEBOX_STORAGE_TOKEN,...c,...t},maxContentLength:1/0,maxBodyLength:1/0}).then((e=>{if(e.data.uploads)for(let t in e.data.uploads)console.log("📦 ",t),console.log("🌐 ",e.data.uploads[t])})).catch((e=>console.error("Error uplaoding:",e)))}})))).then((()=>l(t,"un"))).catch((e=>(console.error(e),l(t,"un"))))})).catch((t=>{console.error("Lock failed:",e,t)})))).then((()=>delete L[e])))}function x(e,o){const n="/"+e+"/"+o.id,c={passportId:a(),date:o.date_updated||o.data_created,vaultId:t(n),refId:o.url||n,type:"directus."+o.layout,data:{stamp:m,importDate:new Date,meta:o}};return O.env.WHITEBOX_GLOBAL||(c.context=_,c.expire=O.env.WHITEBOX_EXPIRE||"10days"),c}const k=h(1e3,(()=>{O.env.WHITEBOX_CLEAR||v.push((()=>{console.log("Clear cache");let e={};return O.env.WHITEBOX_GLOBAL||(e.context=_),H("feed","/api/catalog/clear/cache",e)}))}));async function W({key:e,collection:t},o){const a=new T(t,{schema:o.schema,accountability:o.accountability,knex:o.database});let n=await a.readOne(e,{fields:new Array(O.env.WHITEBOX_LEVEL||5).fill("*").join(".")});if("whitebox"==n.target&&n.layout&&!O.env.WHITEBOX_CLEAR){const e=x(t,n);v.push((()=>(console.log("✔️ ",e.refId),H("feed","/api/catalog/keep/one",e))))}}function R({key:e,collection:o},a){const n="/"+o+"/"+e,c=t(n);O.env.WHITEBOX_CLEAR||v.push((()=>(console.log("🗑️ ",n),H("feed","/api/catalog/remove",{vaultId:c}))))}async function b(){if(!O.clear){let e=await u("**/*",{cwd:w});for(let t of e){t=d.join(w,t);(await f.lstatAsync(t)).isFile()&&await X(t)}}}async function q({key:e,collection:t},o){const a=`/${t}/${e}`;if(I.has(a))return;I.add(a);const n=o.schema.relations.filter((e=>e.collection==t));for(let a of n){const n=new T(t,{schema:o.schema,accountability:o.accountability,knex:o.database}),c=await n.readOne(e,{fields:["*"]});await S({key:c[a.field],collection:a.related_collection},o)}}async function S({key:e,collection:t},o){const a=`/${t}/${e}`;if(I.has(a))return;I.add(a);const n=o.schema.relations.filter((e=>e.related_collection==t));for(let t of n){const a=new T(t.collection,{schema:o.schema,accountability:o.accountability,knex:o.database}),n={[t.field]:Number(e)},c=await a.readByQuery({filter:n});for(let e of c)await q({key:e.id,collection:t.collection},o)}}async function G(e){if(I.size>1){let t=[...I].slice(1);console.log("👁️ ",[t].join(" "));for(let o of t){const[,t,a]=o.split("/");await W({key:a,collection:t},e)}}I.clear()}y("items.create",(async(e,t)=>{await W(e,t),k()})),p("items.update",(async(e,t,o)=>{for(let e of t.keys)await S({key:e,collection:t.collection},o)})),y("items.update",(async(e,t)=>{for(let o of e.keys)await W({key:o,collection:e.collection},t),await S({key:o,collection:e.collection},t);await G(t),k()})),p("items.delete",(async(e,{collection:t},o)=>{for(let a of e)await S({key:a,collection:t,changes:I},o);await G(o),k()})),y("items.delete",(async(e,t)=>{for(let t of e.payload)await R({key:t,collection:e.collection});await G(t),k()})),y("files.upload",b),E("app.after",(async()=>{for(let e of A){const t=new T(e.collection,{schema:g,knex:O.database}),o=await t.readByQuery({fields:new Array(O.env.WHITEBOX_LEVEL||5).fill("*").join(".")}),a=[];console.log("Items:",e.collection,o.length);for(let t of o)if("whitebox"==t.target&&t.layout&&(-1==a.indexOf(t.layout)&&a.push(t.layout),!O.env.WHITEBOX_CLEAR)){const o=x(e.collection,t);v.push((()=>(console.log("✔️ ",o.refId),H("feed","/api/catalog/keep/one",o))))}console.log("♻️ ",a.join(", "));for(let e of a)v.push((()=>H("feed","/api/catalog/expire",{type:"directus."+e,stamp:m})))}k(),await b(),console.log("Application started")}))};
